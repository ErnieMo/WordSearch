<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Transfer Test - WordSearch</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h2 class="card-title mb-0">
                            <i class="fas fa-search me-2"></i>Token Transfer Test - WordSearch
                        </h2>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Test the secure token-based session transfer system between all three
                            applications.</p>

                        <div id="status-messages"></div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Generate Transfer Token</h5>
                                    </div>
                                    <div class="card-body">
                                        <p>Generate a secure token to transfer your session to other apps.</p>
                                        <div class="d-grid gap-2">
                                            <button id="generate-token-btn" class="btn btn-warning">
                                                <i class="fas fa-key me-1"></i>Generate Token
                                            </button>
                                            <button id="check-login-btn" class="btn btn-outline-secondary">
                                                <i class="fas fa-user me-1"></i>Check Login Status
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Test Token Validation</h5>
                                    </div>
                                    <div class="card-body">
                                        <p>Test token validation with a specific token:</p>
                                        <div class="mb-3">
                                            <label for="test-token" class="form-label">Token:</label>
                                            <input type="text" class="form-control" id="test-token"
                                                placeholder="Enter token to test">
                                        </div>
                                        <button id="validate-token-btn" class="btn btn-info">
                                            <i class="fas fa-check me-1"></i>Validate Token
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h5>Generated Token Info</h5>
                            <pre id="token-info" class="bg-light p-3 rounded"></pre>
                        </div>

                        <div class="mt-3">
                            <h5>Transfer URLs</h5>
                            <div id="transfer-urls-container" class="d-none">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">To TileSlider:</label>
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="tileslider-url" readonly>
                                            <a href="#" id="open-tileslider-link" class="btn btn-primary"
                                                target="_blank">
                                                <i class="fas fa-external-link-alt me-1"></i>Open
                                            </a>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">To Sudoku:</label>
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="sudoku-url" readonly>
                                            <a href="#" id="open-sudoku-link" class="btn btn-success" target="_blank">
                                                <i class="fas fa-external-link-alt me-1"></i>Open
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Bind event listeners
            document.getElementById('generate-token-btn').onclick = generateToken;
            document.getElementById('check-login-btn').onclick = checkLoginStatus;
            document.getElementById('validate-token-btn').onclick = validateToken;

            // Generate token function
            async function generateToken() {
                try {
                    showStatus('Generating transfer token...', 'info');

                    const response = await fetch('/api/transfer/generate-token', {
                        method: 'POST',
                        credentials: 'include'
                    });

                    const result = await response.json();

                    if (result.success) {
                        showStatus('Token generated successfully!', 'success');

                        // Display token info
                        document.getElementById('token-info').textContent = JSON.stringify({
                            token: result.token,
                            expires_in: result.expires_in + ' seconds',
                            transfer_urls: result.transfer_urls
                        }, null, 2);

                        // Show transfer URLs
                        const urlsContainer = document.getElementById('transfer-urls-container');
                        const tilesliderUrl = document.getElementById('tileslider-url');
                        const sudokuUrl = document.getElementById('sudoku-url');
                        const tilesliderLink = document.getElementById('open-tileslider-link');
                        const sudokuLink = document.getElementById('open-sudoku-link');

                        tilesliderUrl.value = result.transfer_urls.tileslider;
                        sudokuUrl.value = result.transfer_urls.sudoku;
                        tilesliderLink.href = result.transfer_urls.tileslider;
                        sudokuLink.href = result.transfer_urls.sudoku;
                        urlsContainer.classList.remove('d-none');

                    } else {
                        throw new Error(result.error || 'Failed to generate token');
                    }
                } catch (error) {
                    showStatus('Error: ' + error.message, 'danger');
                }
            }

            // Check login status function
            async function checkLoginStatus() {
                try {
                    const response = await fetch('/api/auth/profile', {
                        method: 'GET',
                        credentials: 'include'
                    });

                    const result = await response.json();

                    if (result.success && result.user) {
                        showStatus(`Logged in as: ${result.user.username}`, 'success');
                    } else {
                        showStatus('Not logged in', 'warning');
                    }
                } catch (error) {
                    showStatus('Error checking login status: ' + error.message, 'danger');
                }
            }

            // Validate token function
            async function validateToken() {
                const token = document.getElementById('test-token').value.trim();

                if (!token) {
                    showStatus('Please enter a token to validate', 'warning');
                    return;
                }

                try {
                    const response = await fetch(`/api/transfer/token-info?token=${encodeURIComponent(token)}`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    const result = await response.json();

                    if (result.success) {
                        showStatus(`Token is valid for user: ${result.user.username}`, 'success');
                    } else {
                        showStatus('Token is invalid or expired: ' + result.error, 'danger');
                    }
                } catch (error) {
                    showStatus('Error validating token: ' + error.message, 'danger');
                }
            }

            // Show status message
            function showStatus(message, type = 'info') {
                const statusDiv = document.getElementById('status-messages');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type} alert-dismissible fade show`;
                alert.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                statusDiv.appendChild(alert);

                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    alert.classList.remove('show');
                    setTimeout(() => alert.remove(), 150);
                }, 5000);
            }

            // Initial login check
            checkLoginStatus();
        });
    </script>
</body>

</html>
